# INCO 仕様書 (Specification)

このドキュメントは、INCOプロジェクトの機能仕様、データモデル、バリデーションルール、およびUIの挙動を定義するものです。開発の進行に合わせて随時更新されます。

## 1. データモデル

### Projects (プロジェクト)
プロジェクトはタスクを管理する最上位の単位です。

| カラム名 | 型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| `id` | BIGINT | PK | 自動採番 |
| `name` | TEXT | NOT NULL | プロジェクト名 |
| `key` | TEXT | **UNIQUE**, NOT NULL | プロジェクトキー (例: `INCO`)。タスク番号のプレフィックスとして使用。 |
| `color` | TEXT | NOT NULL | プロジェクトのテーマカラー (Tailwindクラス名またはHEX) |
| `icon` | TEXT | NULLABLE | **(NEW)** プロジェクトのアイコン識別子 (Lucide icon name) |
| `current_task_number` | INTEGER | DEFAULT 0 | **(NEW)** 現在のタスク連番の最大値。タスク追加時にインクリメントされる。 |
| `created_at` | TIMESTAMPTZ | DEFAULT NOW() | 作成日時 |

### Tasks (タスク)
個々の作業アイテムです。

| カラム名 | 型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| `id` | BIGINT | PK | 自動採番 |
| `project_id` | BIGINT | FK | 所属プロジェクト |
| `key` | TEXT | **UNIQUE**, NOT NULL | **(NEW)** タスクキー (例: `INCO-123`)。DBトリガーにより自動生成。 |
| `title` | TEXT | NOT NULL | タスク名 |
| ... | ... | ... | ... |

## 2. バリデーション & 制約ルール

### プロジェクト作成
*   **Key (プロジェクトキー)**:
    *   **許可文字**: 半角英大文字 (`A-Z`) と 数字 (`0-9`) のみ。
    *   **長さ**: (仕様未定だが推奨: 2~10文字程度)
    *   **一意性**: システム全体でユニークであること。重複時は登録不可。

### タスク作成
*   **Key (タスクキー)**:
    *   ユーザーによる入力は不可。
    *   システムが `{ProjectKey}-{連番}` の形式で自動生成する。
    *   連番はプロジェクトごとに `1` から開始。
    *   **欠番**: トランザクションロールバック等により、番号が飛ぶことは許容する（厳密な連番管理よりパフォーマンスを優先）。

## 3. 画面・UI挙動

### プロジェクト作成モーダル
*   **キー入力**:
    *   小文字が入力された場合、自動的に大文字に変換して表示/保持する。
    *   英数字以外の文字入力は無視または削除する。
*   **重複エラー**:
    *   保存実行時にキーの重複が検知された場合、入力フィールド直下にエラーメッセージ「そのプロジェクトキーは既に使用されています」を表示する。
*   **アイコン選択**:
    *   プリセットされたアイコン一覧から1つを選択可能にする。

### タスク詳細 / ボード / リスト
*   **タスクキー表示**:
    *   タスクの識別子として `INCO-123` のような形式で常に表示する。

### リストビュー (ListView)
*   **インライン編集 / 詳細オープン**:
    *   タスクの「タスク名」の**テキスト部分**をクリックすると、その場で入力モード（テキストボックス）に切り替わる。
    *   **詳細オープン**: テキスト以外の**セル内の余白**をクリックした場合は、タスク詳細パネルを開く。
    *   **表示**: 入力フォームの幅はセルの約75%とし、誤操作を防ぐための余白を設ける。
    *   **終了**: `Enter` キー、`Esc` キー、またはフォーム外（セル内の余白含む）のクリックで保存・終了する。
*   **パネル展開の制御**:
    *   以下の「操作可能な項目」をクリックした際は、詳細パネルを開かず、そのアクションのみを実行する：
        *   完了チェックボタン
        *   タスク名（インライン編集へ）
        *   担当者アイコン
        *   ステータス / 優先度 / 種別 セレクタ
        *   期限日
    *   上記以外の領域（行の余白、キーなど）をクリックした場合のみ、詳細パネルを開く。

### タスク詳細パネル (Task Detail Panel)
*   **開閉挙動**:
    *   URLクエリパラメータ (`?task=ID`) により開閉を制御する。
    *   パネルの外側（他の領域）をクリックした場合、パネルを閉じる。
    *   **自動切り替え**: パネルが開いている状態で、リスト上の「別のタスク」をクリックした場合、パネルを閉じずにそのままクリックしたタスクの詳細に切り替える（クリックスルー）。
*   **ヘッダーアクション**:
    *   `...` (その他メニュー) の左横に「リンクコピー」ボタン (🔗) を配置。クリックで現在のタスクURLをクリップボードにコピーする。
    *   `...` メニュー内に以下の項目を追加:
        *   **タスクを複製**: 現在のタスク名、詳細、属性（担当者、期限など）をコピーして新規タスクを作成する。タイトルには `(コピー)` を付与する。
        *   **タスクを削除**: 確認ダイアログを経てタスクを削除し、パネルを閉じる。
